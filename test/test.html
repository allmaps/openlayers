<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css">

    <script src="https://cdn.jsdelivr.net/npm/@allmaps/annotation@1.0.0-alpha.14/dist/annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@allmaps/transform@1.0.0-alpha.3/dist/transform.min.js"></script>
    <script src="../dist/layers.umd.js"></script>
    <style>
      body {
        position: absolute;
        margin: 0;
        padding: 0;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
      }

      #ol {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="ol"></div>
  </body>

  <script>
    async function fetchJSON (url) {
      const response = await fetch(url)
      const json = await response.json()
      return json
    }

    async function fetchImage (imageUri) {
      const json = await fetchJSON(`${imageUri}/info.json`)
      return json
    }

    const tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'

    const xyz = new ol.source.XYZ(tileUrl)

    const baseLayer = new ol.layer.Tile({
      source: xyz
    })

    const vectorSource = new ol.source.Vector()
    const vectorLayer = new ol.layer.Vector({
      source: vectorSource,
      style: new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'rgb(248, 193, 79)',
          width: 3
        })
      })
    })

    vectorLayer.setZIndex(100)

    const map = new ol.Map({
      layers: [baseLayer, vectorLayer],
      target: 'ol',
      controls: [],
      view: new ol.View({
        enableRotation: false,
        minZoom: 6,
        maxZoom: 20,
        zoom: 12
      })
    })

    const annotationUrl = 'https://annotations.allmaps.org/manifests/84iFEdzE2ssV7qXx'

    loadAnnotation(annotationUrl)

    async function loadAnnotation (annotationUrl) {
      const maps = annotation.parse(await fetchJSON(annotationUrl))
      const firstMap = maps[0]

      const transformArgs = transform.createTransformer(firstMap.gcps)
      const polygon = firstMap.pixelMask
        .map((point) => transform.toWorld(transformArgs, point))

      const geoMask = {
        type: 'Polygon',
        coordinates: [polygon]
      }

      vectorSource.addFeature((new ol.format.GeoJSON()).readFeature(geoMask, { featureProjection: 'EPSG:3857' }))

      const imageUri = firstMap.image.uri
      const image = await fetchImage(imageUri)

      const options = {
        image,
        georeferencedMap: firstMap,
        source: new ol.source.Vector()
      }

      const warpedMapLayer = new allmapsLayers.WarpedMapLayer(options)
      map.addLayer(warpedMapLayer)

      const extent = vectorSource.getExtent()

      map.getView().fit(extent, {
        padding: [10, 10, 10, 10],
        maxZoom: 18
      })
    }
  </script>
</html>
